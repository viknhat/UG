#include "stm32f4xx.h"
#include <stdint.h>
void maxm_read_address(uint8_t reg);
void maxm_write(uint8_t reg, char value);
void I2C1_init(void);
void I2C_byteRead(char saddr, char maddr, char* data);
void I2C_multipleRead(char saddr, char maddr, int n, char* data);
void I2C_multipleWrite(char saddr, char maddr, int n, char* data);
char data;
int led1A[32];
int led1B[32];
int led2A[32];
int led2B[32];
/*-----------------------------------------MAXM86161 Module-----------------------------------------*/
#define FIFO_DATA (0x08) //FIFO Data Register
#define SADDR (0xC5) //Slave Address
#define FLUSH (0x0D) //Reset FIFO Register
void maxm_read_address(uint8_t reg)
{
uint8_t regVal = reg; //Passed Data Register Address
uint8_t dataBuf[128*2*2*3]; //128 FIFO samples, 2 channel, 2 PD, 3 byte/channel
int sampleCnt = 128*2*2*3;
int i = 0;
for ( i = 0; i < sampleCnt; i++ )
{
I2C_multipleRead(SADDR, regVal, sampleCnt, &data);
dataBuf[i]=data;
}
for ( i = 0; i < sampleCnt; i++ )
{
led1A[i] = ((dataBuf[i*12+0] << 16 ) | (dataBuf[i*12+1] << 8) | (dataBuf[i*12+2])) & 0x7ffff; // LED1, PD1
led1B[i] = ((dataBuf[i*12+3] << 16 ) | (dataBuf[i*12+4] << 8) | (dataBuf[i*12+5])) & 0x7ffff; // LED1, PD2
led2A[i] = ((dataBuf[i*12+6] << 16 ) | (dataBuf[i*12+7] << 8) | (dataBuf[i*12+8])) & 0x7ffff; // LED2, PD1
led2B[i] = ((dataBuf[i*12+9] << 16 ) | (dataBuf[i*12+10] << 8) | (dataBuf[i*12+11])) & 0x7ffff; // LED2, PD2
}
}
void maxm_write (uint8_t reg, char value)
{
char data[1];
data[0]=value;
I2C_multipleWrite (SADDR, reg, 1, data);
}
/*--------------------------------------------I2C Module--------------------------------------------*/
#define GPIOBEN (1U<<1) //Enable GPIO Port B
#define I2C1EN (1U<<21) //Bit for I2C Clock Access in Bus APB1
#define I2C_100KHZ (80)
#define SD_MODE_MAX_RISE_TIME (17)
#define CR1_PE (1U<<0) //I2C peripheral enable bit
#define SR2_BUSY (1U<<1) //Busy Indication Bit in Status Reg 2
#define CR1_START (1U<<8) //Start Bit in Control Reg 1
#define SR1_SB (1U<<0) //Start Bit in Status Reg 1
#define SR1_ADDR (1U<<1) //Address status Bit in Status Reg 1
#define SR1_TXE (1U<<7) //TXE (transmission) flag Bit in Status Reg 1
#define CR1_ACK (1U<<10) //Acknowledgment Bit in Control Reg 1
#define CR1_STOP (1U<<0) //Stop Bit in Control Reg 1
#define SR1_RXNE (1U<<6) //RXNE (receiving) flag Bit in Status Reg 1
#define SR1_BTF (1U<<2) //Byte Transfer Finished
void I2C1_init(void)
{
RCC->AHB1ENR |=GPIOBEN; //Enable Clock to Port B
GPIOB->MODER &=~(1U<<16);
GPIOB->MODER |= (1U<<17); //PB8 in alternate function mode to act as SCL
GPIOB->MODER &=~(1U<<18);
GPIOB->MODER |= (1U<<19); //PB9 in alternate function mode to act as SDA
